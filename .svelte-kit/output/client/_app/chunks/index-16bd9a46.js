var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,a=(t,s,o)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[s]=o,r=(e,t)=>{for(var s in t||(t={}))n.call(t,s)&&a(e,s,t[s]);if(o)for(var s of o(t))i.call(t,s)&&a(e,s,t[s]);return e},c=(e,o)=>t(e,s(o));import{a4 as d,a5 as p,a6 as l}from"./vendor-51b7d296.js";import{r as m}from"./singletons-bb9012b7.js";import{t as y,A as g,a as u,p as h,P as f}from"./getAPi-d548b28c.js";const k=async function(e,t){return m.goto(e,t,[])};const b=(e,t=!0)=>(e||(e=""),e.includes("video")||e.includes("audio")||!!t&&e.includes("image"));var v={noStore:["base_url","notify"],storeType:{colorScheme:"localPersistantStore",clipboard:"sessionPersistantStore",render:"sessionPersistantStore"},state:{base_url:"/_app/".replace("_app/",""),context_menu:[],pos:{x:0,y:0},clipboard:null,notify:d,hideFilemenu:!0,render:!1,colorScheme:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"},getters:{dirs(e,t,s=!1){var o;if(t){let n=null==(o=e.dirs.get())?void 0:o[t];if(n&&!0===s)return n;(!n||s&&"boolean"!=typeof s)&&e.dirs.update((o=>(o[t]=s||"/",e.dirs.set(o),o)))}return e.dirs}},mutations:{setColorScheme(e,t){e.colorScheme.set(t),localStorage.setItem("colorScheme",t)},updateDirs(e,t,s=""){e.dirs.update((e=>(e[t]=s,e)))}},actions:{open:async({state:e,commit:t,dispatch:s,g:o},{path:n,isFile:i,size:a,storage:d,dkey:p,dir:l,ctype:m,inBrowser:h=!1}={})=>{if(m||(m=""),i){console.log("open",{size:a,storage:d,dkey:p,isFile:i,path:n,ctype:m});const t=d+y({path:escape(n),dkey:p,ctype:m,size:a});if(b(m,!0))if(m.includes("image")||h||!e.serverStore.get().isMpvInstalled){k(`/view/media-${t}`)}else{const e=g+"/media"+y({storage:d,path:escape(n),dkey:p,ctype:m,size:a});u.post("/mpv_stream",{url:e})}else if(m.includes("text")||m.includes("json")){k(`/view/text-${t}`)}else if(m.includes("pdf")){k(`/view/embed-${t}`)}}else{if(l=l||"/",n&&(l=n,t("updateDirs",p,n)),!e.socket)return;s("loading","load-page");const o={dir:l,show_hidden:e.show_hidden.get()};"fs"===d?(e.socket.on("ready",(()=>{e.socket.signal("fs-list",o)})),e.socket.signal("fs-list",o)):(e.socket.on("ready",(()=>{e.socket.signal("drive-list",c(r({},o),{dkey:p}))})),e.socket.signal("drive-list",c(r({},o),{dkey:p})))}},setupMenuItems({dispatch:e,commit:t,g:s,state:o},{size:n,storage:i,dkey:a,isFile:r,path:c,dir:d,name:p,ctype:l}){const m=[{name:"open",action:()=>{e("open",{size:n,storage:i,dkey:a,isFile:r,dir:d,path:c,ctype:l}),e("context_menu",[])}},{name:"play in browser",action:()=>{e("open",{size:n,storage:i,dkey:a,isFile:r,dir:d,path:c,ctype:l,inBrowser:!0}),e("context_menu",[])},disabled:!b(l,!1)},{name:"download",action:()=>{e("context_menu",[]);const t=document.createElement("a");t.href=g+`/download?storage=${i}&dkey=${a}&type=${r?"file":"dir"}&size=${n}&path=${escape(c)}`,document.body.appendChild(t),t.target="_blank",t.click(),t.remove()}},{name:"copy",action:()=>{e("clipboard",{path:c,dkey:a,name:p}),o.notify.success(`${c.split("/").reverse()[0]} copied`),e("context_menu",[])}},{name:"paste",action:()=>{const t=s("clipboard").get(),n={path:r||c.endsWith("/")?c:c+"/",dkey:a,name:p},i=`${t.path}-${n.path}`;o.socket.signal("paste-copied",{src:t,dest:n}),e("context_menu",[]);const d=e=>{e.dest.path===n.path&&e.src.path===t.path&&(o.socket.off(i,d),o.success("pasted "+t.name+" to "+n.name))};o.socket.on(i,d)},disabled:!s("clipboard").get()},{name:"delete",action:()=>{o.socket.signal("delete-path-item",{path:c,dkey:a,name:p}),e("context_menu",[])}}];e("context_menu",m)},setupMainMenuItems({dispatch:e,commit:t,g:s,state:o},{storage:n,dkey:i,dir:a,name:r}){const c=[{name:"new",action(){},options:{},disabled:!0},{name:"paste",action:()=>{const t=s("clipboard").get(),n={path:a.endsWith("/")?a:a+"/",dkey:i,name:r},c=`${t.path}-${n.path}`;o.socket.signal("paste-copied",{src:t,dest:n}),e("context_menu",[]);const d=e=>{e.dest.path===n.path&&e.src.path===t.path&&(o.socket.off(c,d),o.success("pasted "+t.name+" to "+n.name))};o.socket.on(c,d)},disabled:!s("clipboard").get()}];e("context_menu",c)}}};const w=()=>null,S=({visible:e=!1,message:t="Here is a Prompt",acceptText:s="accept",dismissText:o="dismiss",onaccept:n=w,ondismiss:i=w}={})=>({visible:e,message:t,onaccept:()=>new Promise(((e,t)=>{try{e(n())}catch(s){t(s)}})),ondismiss:()=>new Promise(((e,t)=>{try{e(i())}catch(s){t(s)}})),acceptText:s,dismissText:o});var P={state:{prompt:S()},mutations:{updatePromptValues(e,t={}){e.prompt.update((e=>{for(let s in t)return e[s]=t[s],e}))}},actions:{async showPrompt({commit:e},t){e("prompt",t=S(c(r({},t),{visible:!0})))},async hidePrompt({commit:e}){e("prompt",S({visible:!1}))}}},_=l([v,P,{noStore:["api","socket","serverStore","pagination"],storeType:{dkey:"sessionPersistantStore",show_hidden:"sessionPersistantStore",dirs:"sessionPersistantStore"},state:{api:null,pagination:{},loading:"load-page",socket:null,serverStore:null,drives:[],dkey:"fs",folder:[],dirs:{fs:"/"},show_hidden:!0},actions:{async startConnection({state:e,commit:t,dispatch:s,g:o}){if(console.log("starting connection"),e.socket&&e.api)return;const{socket:n,api:i,serverStore:a}=(()=>{var e,t,s;const o=window.location.hostname,n=new p({address:o,protocol:"dmtapp",port:h,lane:"hyp"});return{socket:n.connector,api:null==(s=null==(t=null==(e=n.remoteObject)?void 0:e.bind)?void 0:t.call(e,n))?void 0:s("dmtapp:hyp"),serverStore:n}})();s("socket",n),s("api",i),s("serverStore",a),n.connected&&n.signal("signal-connect"),n.on("ready",(()=>{n.signal("signal-connect")})),n.on("signal-connect",(t=>{console.log("settings",t),e.notify.info("connections ready")})),n.on("folder",(({items:o,page:n,total:i})=>{s("pagination",new f({total:i,page:n})),1===n?t("folder",o||[]):e.folder.update((e=>[...e,...o||[]])),t("loading",!1)})),n.on("notify-danger",(async t=>{e.notify.danger(t,1e4)})),n.on("notify-info",(async t=>{e.notify.info(t)})),n.on("notify-warn",(async t=>{e.notify.warning(t,5e3)})),n.on("notify-success",(async t=>{e.notify.success(t)})),n.on("child-process:spawn",(({pid:t,cm:s})=>{e.notify.info(`child-process:${s} spawning with PID: ${t}`)})),n.on("child-process:exit",(t=>{e.notify.info(t)})),n.on("child-process:killed",(t=>{e.notify.info(t)})),n.on("storage-updated",(t=>{const n=e.dkey.get();if(n==n){const e=o("dirs",n,!0);s("open",{dir:e,dkey:n,storage:"fs"!==n?"drive":"fs"})}})),a.subscribe((e=>{console.log("server-store",e)}))}}}],{mutation:"",action:"",getter:""});export{_ as s};
